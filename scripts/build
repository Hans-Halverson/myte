#!/bin/sh

set -e

CURRENT_DIR=$(cd "$(dirname "$0")" && pwd)
ROOT_DIR=$(dirname "$CURRENT_DIR")

# Build myte executable
cd "$ROOT_DIR/src"
opam exec -- dune build myte.exe --no-print-directory "$@"

# Build test suite
cd "$ROOT_DIR/test"
opam exec -- dune build run_tests.exe --no-print-directory

# Set up and build library
BUILD_DIR="$ROOT_DIR/build"
rm -rf "$BUILD_DIR"
mkdir "$BUILD_DIR"

# Copy library files into build directory
cp -r "$ROOT_DIR/lib" "$BUILD_DIR/lib"

# Build runtime library
cd "$BUILD_DIR/lib/runtime"
clang -c ./*.S